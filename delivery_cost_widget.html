<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Key-Value Pair Widget</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    .container {
      padding: 10px;
    }
    .status {
      margin-bottom: 10px;
      color: green;
    }
    .error {
      color: red;
    }
    .key-value-container {
      margin-top: 10px;
    }
    .key-value-item {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h3>Key-Value Pair Widget</h3>
    <p id="status" class="status">Initializing widget...</p>
    <div id="keyValueContainer" class="key-value-container"></div>
  </div>

  <script>
    (function () {
      let keyValuePairs = {};

      // Log function for debugging
      const log = (message, isError = false) => {
        const status = document.getElementById('status');
        status.textContent = message;
        status.className = isError ? 'status error' : 'status';
      };

      // Check if JFCustomWidget is defined
      if (typeof JFCustomWidget === 'undefined') {
        log('JFCustomWidget is not defined. Ensure the widget is running in Jotform.', true);
        console.error('JFCustomWidget is not defined.');
        return;
      }

      // Subscribe to the 'ready' event
      JFCustomWidget.subscribe('ready', function () {
        log('Widget is ready! Waiting for input from form fields...');
        console.log('Widget is ready.');
      });

      // Subscribe to the 'input' event to receive data from Jotform fields
      JFCustomWidget.subscribe('input', function (data) {
        if (data && data.field && data.value) {
          log(`Received input from field: ${data.field}`);
          try {
            // Assume the input is JSON data
            const inputData = JSON.parse(data.value);

            // Merge new data into keyValuePairs object
            Object.assign(keyValuePairs, inputData);

            // Update the display
            const container = document.getElementById('keyValueContainer');
            container.innerHTML = ''; // Clear current display

            Object.entries(keyValuePairs).forEach(([key, value]) => {
              const itemDiv = document.createElement('div');
              itemDiv.className = 'key-value-item';
              itemDiv.textContent = `${key}: ${value}`;
              container.appendChild(itemDiv);
            });
          } catch (error) {
            log('Error parsing input data. Ensure it is valid JSON.', true);
            console.error('Error parsing JSON:', error);
          }
        } else {
          log('No valid input data received.', true);
        }
      });

      // Subscribe to the 'submit' event
      JFCustomWidget.subscribe('submit', function () {
        log('Submitting widget data...');
        console.log('Submitting data:', keyValuePairs);

        // Send the key-value pairs back to the form
        JFCustomWidget.sendSubmit({
          valid: true,
          value: JSON.stringify(keyValuePairs)
        });
      });
    })();
  </script>
</body>
</html>
