<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Date Field Key-Value Widget</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    .container {
      padding: 10px;
    }
    .status {
      margin-bottom: 10px;
      color: green;
    }
    .error {
      color: red;
    }
    .key-value-container {
      margin-top: 10px;
    }
    .key-value-item {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h3>Date Field Key-Value Widget</h3>
    <p id="status" class="status">Initializing widget...</p>
    <div id="keyValueContainer" class="key-value-container"></div>
  </div>

  <script>
    (function () {
      let keyValuePairs = {};

      // Log function for debugging
      const log = (message, isError = false) => {
        const status = document.getElementById('status');
        status.textContent = message;
        status.className = isError ? 'status error' : 'status';
      };

      // Check if JFCustomWidget is defined
      if (typeof JFCustomWidget === 'undefined') {
        log('JFCustomWidget is not defined. Ensure the widget is running in Jotform.', true);
        console.error('JFCustomWidget is not defined.');
        return;
      }

      // Subscribe to the 'ready' event
      JFCustomWidget.subscribe('ready', function () {
        log('Widget is ready! Waiting for input from form fields...');
        console.log('Widget is ready.');
      });

      // Subscribe to the 'input' event to receive data from Jotform fields
      JFCustomWidget.subscribe('input', function (data) {
        if (data && data.field && data.value) {
          // Filter for Date fields only
          if (isDateField(data.field)) {
            log(`Received input from a Date field: ${data.field}`);
            try {
              // Assume the input is a valid date
              keyValuePairs[data.field] = data.value; // Store the date value

              // Update the display
              const container = document.getElementById('keyValueContainer');
              container.innerHTML = ''; // Clear current display

              Object.entries(keyValuePairs).forEach(([key, value]) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'key-value-item';
                itemDiv.textContent = `Field: ${key}, Date: ${value}`;
                container.appendChild(itemDiv);
              });
            } catch (error) {
              log('Error processing date field input.', true);
              console.error('Error processing date field:', error);
            }
          } else {
            log(`Ignored input from non-date field: ${data.field}`);
          }
        } else {
          log('No valid input data received.', true);
        }
      });

      // Subscribe to the 'submit' event
      JFCustomWidget.subscribe('submit', function () {
        log('Submitting widget data...');
        console.log('Submitting data:', keyValuePairs);

        // Send the key-value pairs back to the form
        JFCustomWidget.sendSubmit({
          valid: true,
          value: JSON.stringify(keyValuePairs)
        });
      });

      // Helper function to check if the field is a Date field
      function isDateField(fieldId) {
        // Example logic: Check if the field ID contains "date" or is part of a predefined list
        const dateFieldIds = ['dateField1', 'dateField2']; // Replace with actual field IDs
        return dateFieldIds.includes(fieldId) || fieldId.toLowerCase().includes('date');
      }
    })();
  </script>
</body>
</html>
